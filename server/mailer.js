require('dotenv').config();
var nodemailer = require('nodemailer');

module.exports = (requestObject) => {
  // create the message header
  var message = '<div style="max-width: 800px;"><h3>New Dealer Application</h3>';
  var sendTo, printedName, signedDate, fromEmail;
  var attachments = [];

  // add all of the form fields to the message text
  Object.entries(requestObject.body).forEach(
    formField => {
      if(formField[0] == 'testing-sendTo') {
        sendTo = formField[1];
      } else if(formField[0] == 'signature' ) {
        attachments.push({
          filename: 'signature.png',
          content: new Buffer(formField[1].split(',')[1], 'base64'),
          cid: 'signature'
        });
      } else if(formField[0] == 'Printed Name') {
        printedName = formField[1];
        message += `${formField[0]}: ${formField[1]} <br>`;
      } else if(formField[0] == 'Billing Contact Email') {
        fromEmail = formField[1];
        message += `${formField[0]}: ${formField[1]} <br>`;
      } else if(formField[0] == 'Dated') {
        signedDate = formField[1];
        message += `${formField[0]}: ${formField[1]} <br>`;
      } else if(formField[1] != '' && formField[1] != '-' && formField[1] != '- ' && formField[0] != 'terms-check') {
        message += `${formField[0]}: ${formField[1]} <br>`;
      } 
    }
  );

  // add all of the files to the attachment array
  if(requestObject.files) {
    if (!Array.isArray(requestObject.files.photos)) {
      attachments.push({
        filename: requestObject.files.photos.name,
        content: requestObject.files.photos.data
      })
    } else {
      Object.entries(requestObject.files.photos).forEach(
        photoArr => {
          attachments.push({
            filename: photoArr[1].name,
            content: photoArr[1].data,
          });
        }
      );
    }
  }

  // add the terms and conditions
  message += '<hr><span class="c4">Terms and Conditions</span></p>'
  message += '<meta content="text/html; charset=UTF-8" http-equiv="content-type">'
  message += '<style type="text/css">ol{margin:0;padding:0}table td,table th{padding:0}.c5{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c7{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left;height:11pt}.c1{color:#303030;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:12pt;font-family:"Arial";font-style:normal}.c0{padding-top:0pt;padding-bottom:11pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c4{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c2{color:#e52727;font-size:12pt}.c6{color:#303030;font-size:12pt}.c3{color:inherit;text-decoration:inherit}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style>'
  message += '<body class="c4"><p class="c0"><span class="c1">THIS AUTHORIZED DEALER AGREEMENT (&ldquo;Agreement&rdquo;) is made as of the Effective Date (as defined on the signature page) by and between S&amp;B Filters, Inc. (&ldquo;S&amp;B&rdquo;), a California corporation, located at the address shown on the signature page, and the Authorized Dealer (&ldquo;Dealer&rdquo;), located at the address shown above. (For certain definitions of capitalized terms, see Section 7 of this Agreement.)</span></p><p class="c0"><span class="c1">1. Appointment.</span></p><p class="c0"><span class="c1">Subject to the terms and conditions of this Agreement, S&amp;B appoints the Dealer and the Dealer agrees to perform as a S&amp;B Nonexclusive Authorized Dealer for the Products during the Term. Except as expressly authorized in writing by S&amp;B, the Dealer agrees to submit purchase orders for the Products to available Warehouse Distributors (&ldquo;Distributors&rdquo;) during the Term, subject to the terms and conditions of sale determined between the Dealer and each such Distributor (but consistent with this Agreement) to purchase from such Distributor the Products described in each purchase order. If Dealer desires to act as a Distributor, Dealer must obtain prior written approval from S&amp;B.</span></p><p class="c0"><span class="c1">A Distributor shall only sell the Products to Authorized Dealers. Upon written notice and direction from S&amp;B, a Distributor shall immediately cease selling or supplying the Products to Dealer(s) and cancel any and all pending orders to Dealer(s).</span></p><p class="c0"><span class="c1">2. Prohibited Sales Channels.</span></p><p class="c0"><span class="c6">Dealer shall be in breach of this Agreement if Dealer offers or sells the Products on Amazon Marketplace, Amazon Prime, Walmart Marketplace, eBay or similar channels, marketplaces, mediums or websites except as noted on the </span><span class="c2"><a class="c3" href="https://www.google.com/url?q=https://docs.google.com/spreadsheets/d/1WzPW-WCVxJK3Qim7yEmXgVojGkwV-zvZofQp5F9F5us/edit%23gid%3D0&amp;sa=D&amp;ust=1601452463763000&amp;usg=AOvVaw3b9Ygr5uYhzWWwGs3udrWT">S&amp;B Product List</a></span><span class="c1">.</span></p><p class="c0"><span class="c1">3. Dealer&#39;s Duties.</span></p><p class="c0"><span class="c1">Dealer&rsquo;s duties under this Agreement include the following: (a) promote the sale and use of the Products; (b) promptly and effectively respond to questions and service requests from customers and prospective customers; (c) represent the Products in an ethical and professional manner and refrain from any conduct that is or could be detrimental to the reputation and integrity of other S&amp;B Dealers, Distributors and/or S&amp;B; (d) use the Intellectual Property only as permitted and approved by S&amp;B; (e) refrain from challenging, infringing or violating, directly or indirectly S&amp;B&rsquo;s or its Affiliate(s)&rsquo; ownership and legal rights in the Intellectual Property or assisting any third-party in doing so; (f) comply with all applicable laws and regulations; and (g) promptly comply with any request made by S&amp;B or the Distributors relating to any law, regulations or the modification or recall of any or all of the Products.</span></p><p class="c0"><span class="c1">4. Termination.</span></p><p class="c0"><span class="c1">This Agreement shall terminate effective upon written notice by either Party to the other Party. Upon termination of this Agreement, the Dealer shall immediately cease holding himself or itself out as a Dealer, or any conduct that would give the impression that the Dealer is an Authorized Dealer, representative of S&amp;B or for the Products, or has any affiliation whatsoever with S&amp;B or the Products.</span></p><p class="c0"><span class="c1">5. Repurchase of Products Upon Termination.</span></p><p class="c0"><span class="c1">Upon termination of this Agreement, S&amp;B shall have the option upon written notice to Dealer to repurchase all or any portion of the terminated Dealer&rsquo;s inventory of the Products (free of all damage, liens, claims and encumbrances) identified by S&amp;B. The repurchased Products will be purchased at the price that the terminated Dealer originally paid, less a restocking charge of fifteen percent (15%) of such price and less discount for damaged or defective Products. The terminated Dealer shall pay the freight and all related charges to ship the repurchased Products as directed by S&amp;B. If S&amp;B does not exercise its options as described herein, Dealer may sell its inventory of the Products, subject to and in accordance with the terms of this Agreement.</span></p><p class="c0"><span class="c1">6. Certain Definitions:</span></p><p class="c0"><span class="c1">For purposes of this Agreement: (a) &ldquo;Nonexclusive Authorized Dealer&rdquo; means that the Dealer may hold itself out as a non-exclusive dealer authorized by S&amp;B to offer and sell the Products during the Term; (b) the &ldquo;Products&rdquo; means those products made available to the Dealer by any or all Distributors specifically authorized by S&amp;B to sell to the Dealer; (c) the &ldquo;Term&rdquo; means the period from the Effective Date until this Agreement is terminated; (d) the &ldquo;Intellectual Property&rdquo; means any or all of the patents, designs, trademarks, service marks, trade names, commercial symbols, copyrights, data, databases, market information, trade secrets and confidential information in which S&amp;B or its Affiliate(s) claim(s) rights; (e) &ldquo;Affiliate(s)&rdquo; means any or all of the individual(s), entity and entities controlling, controlled by or under common control with the Party identified; (f) the &ldquo;S&amp;B Policies&rdquo; means collectively the then-current version(s) of the announcements and policies (whether in the form of correspondence, memoranda, notices or otherwise) from time to time issued in writing or made available electronically by S&amp;B to the Dealer and not expressly excluded by S&amp;B from the S&amp;B Policies (For the avoidance of doubt, S&amp;B&rsquo;s Unilateral Pricing Policy is not an agreement between S&amp;B and Dealer and merely sets forth S&amp;B&rsquo;s minimum resale price for which Products may be sold. Dealer is free to set its own resale prices, but selling below S&amp;B&rsquo;s minimum resale price will be a violation of the Unilateral Pricing Policy and S&amp;B and its Distributors and S&amp;B will cease providing Products to Dealer in accordance with the Unilateral Pricing Policy. Any and all inquires or questions regarding Authorized Dealer Program Unilateral Pricing Policy must be directed to only Berry Carter, President, at 909-947-0015 bcarter@sbfilters.com.); and (g) a &ldquo;Party&rdquo; means S&amp;B or the Dealer and the &ldquo;Parties&rdquo; means S&amp;B and the Dealer.</span></p><p class="c0"><span class="c1">7. Miscellaneous.</span></p><p class="c0"><span class="c1">(a) This Agreement and any and all duties and obligations hereunder may not be delegated, transferred or assigned by the Dealer without the express written consent of S&amp;B. Each delegation, transfer or assignment by the Dealer without such consent shall be null and void. The relationship between S&amp;B and the Dealer shall be that of independent contractors, and nothing in this Agreement shall constitute or be deemed to constitute a partnership, joint venture or franchise between S&amp;B and the Dealer, nor shall the Dealer be deemed or authorized an agent of S&amp;B for any purpose whatsoever. The Dealer shall have no authority or power to bind S&amp;B or to contract in the name of and create a liability against S&amp;B in any way for any purpose.</span></p><p class="c0"><span class="c1">(b) S&amp;B may, at any time, at its sole discretion and without prior notice modify this Agreement, the S&amp;B Policies and/or the Products. The Dealer acknowledges and agrees that S&amp;B or the Distributors may without liability or penalty cancel all pending Product orders (even if accepted from the Dealer for such changed or modified Products) and refuse to accept any new orders from the Dealer for such Products. Except as otherwise expressly provided in this Agreement, each modification of the S&amp;B Policies shall be effective immediately, unless S&amp;B notifies the Dealer in writing of another effective date. S&amp;B&rsquo;s interpretation of each of the S&amp;B Policies will control.</span></p><p class="c0"><span class="c1">(c) This Agreement shall be governed by and interpreted under the laws of the State of California without regard to that state&rsquo;s conflicts of laws provisions. Any and all disputes arising out of or relating in any way to this Agreement between the Parties (or the Affiliate(s) of either) shall be litigated at the trial level as a bench trial only in federal or state court in County of San Bernardino, California. The Parties hereby expressly waive their right to a jury trial. The Dealer, on behalf of itself and its Affiliate(s) hereby submits to personal and subject matter jurisdiction in such courts and agrees that neither the Dealer nor the Dealer&rsquo;s Affiliate(s) will contest venue.</span></p><p class="c0"><span class="c1">(d) Time is of the essence of this Agreement. This Agreement shall be deemed to reflect the mutual intent of the Parties, and no rule of strict construction shall be applied against either Party. S&amp;B shall not be liable for loss, damage or delay resulting from any cause whatsoever beyond its reasonable control. In the event of any conflict between the S&amp;B Policies and this Agreement, the S&amp;B Policies will control. Wherever required by the context hereof, each pronoun used herein shall be deemed to include both the singular and the plural and to encompass each gender.</span></p>'
  message += '<p class="c0"><span class="c1">(e) If applicable law contains any requirement that is contrary to, conflicts with or is missing from any provision(s) or part(s) thereof in this Agreement, S&amp;B, at any time, may elect by written notice to the Dealer (effective upon receipt thereof or as otherwise designated by S&amp;B therein) that: (i) such requirement be substituted for or added to such provision(s) or part(s) thereof to the minimum extent necessary to validate such provision(s) or part(s) thereof; or (ii) this Agreement be terminated. If any provision(s) or part(s) thereof in this Agreement shall be held invalid, the remainder of this Agreement shall continue in full force and effect, and each such provision or part thereof shall be deemed not to be part of this Agreement.</span></p><p class="c0"><span class="c1">(f) This Agreement and each of the S&amp;B Policies, as modified from time to time by S&amp;B: (i) constitute the entire understanding of the Parties binding upon them; (ii) are intended to govern the relationship between the Parties; (iii) supersede all agreements, representations or statements between the Parties, either oral or written; and (iv) except as otherwise provided herein with respect to S&amp;B&rsquo;s right to amend or modify this Agreement at any time without notice, may be amended or modified Dealer only by a written supplement, duty executed by both of the Parties.</span></p><p class="c0"><span class="c1">(g) Except as otherwise provided in this Agreement or as the Parties otherwise may expressly agree in writing, no failure, refusal, neglect, delay, waiver, forbearance or omission by S&amp;B to exercise any right(s) under this Agreement or to insist upon full compliance by the Dealer with the Dealer&rsquo;s duties, obligations, representations, or restrictions hereunder shall constitute a novation or waiver of any provision(s) of this Agreement or otherwise thereafter limit S&amp;B&rsquo;s right to fully enforce any or all of the provision(s) and part(s) thereof of this Agreement.</span></p><p class="c0"><span class="c1">(h) The following shall survive the termination of this Agreement: (i) Sections 2, 3, 5, 6 and 7; (ii) each of the definitions contained in this Agreement; and (iii) each of the S&amp;B Policies which by their own terms expressly states that it survives the termination of this Agreement or which S&amp;B otherwise designates as so surviving.</span></p><p class="c0"><span class="c1">(i) Each notice described in this Agreement to either Party must be in writing and shall be sent to the intended recipient (with all fees paid) by certified mail, express courier service, facsimile or e-mail to such recipient&rsquo;s address referred to on the first (1st) page of this Agreement (which address may be amended by written notice to the other Party) and shall be considered effective or received when actually received or refused by such recipient, provided that the sending Party has written confirmation thereof and such refusal was not due to electronic or mechanical malfunction or failure.</span></p><p class="c0"><span class="c1">(j) LIMITATION OF LIABILITY: IN NO EVENT SHALL S&amp;B, OR ITS OFFICERS, DIRECTORS, SHAREHOLDERS, EMPLOYEES, OR ASSIGNS (&ldquo;S&amp;B PARTIES&rdquo;) BE LIABLE FOR ANY INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES ARISING OUT OF OR IN CONNECTION WITH THE PRODUCTS OR SERVICES OFFERED BY S&amp;B, INCLUDING, WITHOUT LIMITATION, ANY DAMAGES RESULTING FROM LOSS OF USE, DATA, OR PROFITS, WHETHER OR NOT S&amp;B HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES, OR FOR ANY DAMAGES FOR PERSONAL OR BODILY INJURY OR EMOTIONAL DISTRESS ARISING OUT OF OR IN CONNECTION WITH THE PRODUCTS OR THESE TERMS, ON ANY THEORY OF LIABILITY, WHETHER BASED ON WARRANTY, COPYRIGHT, CONTRACT, TORT (INCLUDING NEGLIGENCE), PRODUCT LIABILITY OR ANY OTHER LEGAL THEORY.</span></p><p class="c0"><span class="c1">(k) Dealer agrees to indemnify and hold S&amp;B Parties harmless from any losses, damages, costs, liabilities and expenses (including reasonable attorneys&rsquo; fees) relating to or arising out of: (a) Dealer&rsquo;s marketing, sale, distribution and/or installation of the Products; or (b) Dealer&rsquo;s violation of this Agreement or any S&amp;B Policies. S&amp;B reserves the right, at its own cost, to assume the exclusive defense and control of any matter otherwise subject to indemnification by Dealer, in which event Dealer will fully cooperate with S&amp;B in asserting any available defenses.</span></p><p class="c0"><span class="c1">(l) Dealer acknowledge that in its performance of its duties under this Agreement, Dealer will may receive certain confidential and proprietary information belonging to S&amp;B, including without limitation information concerning the Products, future Products, the know-how, technology, Intellectual Property, techniques, or business or marketing plans thereto (collectively, the &ldquo;Confidential Information&rdquo;) all of which are confidential and proprietary to, and trade secrets of, S&amp;B. Confidential Information does not include information that: (i) is public knowledge at the time of disclosure by S&amp;B; (ii) becomes public knowledge or known to the Dealer after disclosure by S&amp;B other than by breach of the Dealer&rsquo;s obligations under this section or by breach of a third party&rsquo;s confidentiality obligations; (iii) was known by the Dealer prior to disclosure by S&amp;B other than by breach of a third party&rsquo;s confidentiality obligations; or (iv) is independently developed by the Dealer. As a condition to receipt of the Confidential Information from S&amp;B, the Dealer shall: (i) not disclose in any manner, directly or indirectly, to any third party any portion of S&amp;B&rsquo;s Confidential Information; (ii) not use S&amp;B&rsquo;s Confidential Information in any fashion except in accordance with this Agreement or with S&amp;B&rsquo;s expressed prior written consent; (iii) disclose S&amp;B&rsquo;s Confidential Information, in whole or part, only to employees and agents who need to have access thereto for the Dealer&rsquo;s internal business purposes; (iv) take all necessary steps to ensure that its employees and agents are informed of and comply with the confidentiality restrictions contained in this Agreement; and (v) take all necessary precautions to protect the confidentiality of the Confidential Information received hereunder and exercise at least the same degree of care in safeguarding the Confidential Information as Dealer would with its own confidential information, and in no event shall apply less than a reasonable standard of care to prevent disclosure. The Dealer shall promptly notify S&amp;B of any unauthorized disclosure or use of the Confidential Information. The Dealer shall cooperate and assist S&amp;B in preventing or remedying and such unauthorized use or disclosure.</span></p><p class="c0"><span class="c6">(m) The current version of this Agreement, which may be amended or modified by S&amp;B without notice from-time-to-time, can be at found at this </span><span class="c2"><a class="c3" href="https://www.google.com/url?q=https://drive.google.com/file/d/184C8Ai65I_fLPTvroLyaazIoDutEGGm3/view&amp;sa=D&amp;ust=1601452463767000&amp;usg=AOvVaw1LiRv4nwVVlXgraMBuizSL">link</a></span><span class="c1">.</span></p><p class="c0"><span class="c1">(n) Each Party, intending this Agreement to be effective as of the Effective Date, has caused this Agreement to be executed by its duly authorized representative.</span></p><p class="c7"><span class="c5"></span></p></body>'

  // embed the signature
  message += `<img src="cid:signature" style="max-width: 400px;"><br><div>Signed by ${printedName} on ${signedDate}</div></div>`

  // initialize transport object with email credentials
  const transporter = nodemailer.createTransport({
    service: 'gmail',
    auth: {
      user: process.env.EMAIL,
      pass: process.env.PASSWORD
    }
  });

  // configure the message
  const mailOptions = {
    from: fromEmail, 
    to: "customerservice@sbfilters.com", // customerservice@sbfilters.com
    subject: `New Dealer Application - ${printedName}`,
    html: message, // message text variable
    attachments: attachments // attachment array
  };

  if(printedName != null) {
    // send the message, listen for error
    transporter.sendMail(mailOptions, function(error, info){
      if (error) {
        console.log(error);
      } else {
        console.log('Email sent: ' + info.response);
      }
    }); 
  }

}
